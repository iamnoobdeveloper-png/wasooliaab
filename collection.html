<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Font Awesome for Sidebar Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transaction - Wasooli AAB</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f3f8ff;
      font-family: "Poppins", sans-serif;
    }
    .sidebar {
      width: 240px;
      background-color: #2196f3;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      color: white;
      overflow-y: auto;
    }
    .sidebar ul { list-style: none; padding: 0; margin: 0; }
    .sidebar ul li {
      padding: 12px 20px;
      cursor: pointer;
      transition: 0.2s;
    }
    .sidebar ul li:hover {
      background: rgba(255,255,255,0.2);
      border-radius: 8px;
    }
    .main-content {
      margin-left: 260px;
      padding: 20px;
    }
    .btn-primary {
      background-color: #2196f3;
      border: none;
      border-radius: 8px;
    }
    .btn-primary:hover { background-color: #1976d2; }
    table th { background-color: #f1f5ff; }
    .card { border-radius: 10px; border: none; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    input.amount-input {
      width: 90px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 2px 5px;
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <div class="sidebar"></div>

 <!-- MAIN CONTENT -->
  <div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="fw-semibold">Collection Management</h5>
      <div class="col-md-3">
        <select id="clientSelect" class="form-select" onchange="loadClientInfo()">
          <option value="">Select Client</option>
          <option value="Imran">Imran Khan</option>
          <option value="Hassan">Hassan Ali</option>
          <option value="Bilal">Bilal Ahmed</option>
        </select>
      </div>
    </div>

    <!-- CLIENT INFO + PENDING TABLE -->
    <div class="row g-3">
      <div class="col-md-4">
        <div class="client-info" id="clientInfo">
          <h6 class="fw-semibold text-primary">Client Information</h6>
          <p class="mb-1"><strong>Name:</strong> â€”</p>
          <p class="mb-1"><strong>Address:</strong> â€”</p>
          <p class="mb-1"><strong>Contact:</strong> â€”</p>
        
          <p class="mb-1"><strong>Status:</strong> â€”</p>
        </div>
      </div>

      <div class="col-md-8">
        <div class="card p-3">
          <h6 class="fw-semibold mb-3">Pending Balances</h6>
          <table class="table table-bordered align-middle" id="pendingTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Address</th>
                <th>Month/Year</th>
                <th>Balance</th>
                <th>Status</th>
                <th>Collected Amount</th>

                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- COLLECTED AMOUNTS TABLE -->
    <div class="card p-3 mt-4">
      <h6 class="fw-semibold mb-3">Collected Amounts</h6>
      <table class="table table-bordered align-middle" id="collectedTable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Address</th>
            <th>Month/Year</th>
            <th>Collected Amount</th>
            <th>Empty Bottle Received</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<div class="modal fade" id="bottleModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Bottle Management</h6>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Client:</strong> <span id="bottleClientName"></span></p>

        <label class="form-label fw-semibold mt-2">Select Scenario</label>
        <select id="bottleScenario" class="form-select mb-3" onchange="updateScenarioFields()">
          <option value="">Select Scenario</option>
          <option value="permanent">Permanent Bottle Increase</option>
          <option value="temporary">Temporary Bottle Increase</option>
          <option value="replacement">Free Replacement</option>
        </select>

        <div id="bottleFields"></div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="saveBottleChanges()">Save</button>
      </div>
    </div>
  </div>
</div>




 <div class="modal fade" id="collectModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title">Confirm Collection</h6>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
     <div class="modal-body">
  <p><strong>Client:</strong> <span id="modalClientName"></span></p>
  <p><strong>Pending Amount:</strong> PKR <span id="modalAmount"></span></p>
  
  <div class="mt-3">
    <label class="form-label fw-semibold">Received Amount</label>
    <input type="number" id="receivedAmount" class="form-control mb-3" placeholder="Enter amount received" />
  </div>

  <div class="mt-3">
    <label class="form-label fw-semibold">Empty Bottles Received</label>
    <input type="number" id="bottlesReceived" class="form-control" placeholder="Enter empty bottles received" />
  </div>
</div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="confirmCollection()">Collect</button>
      </div>
    </div>
  </div>
</div>
  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const clients = {
  Imran: { name: "Imran Khan", address: "Block 10-A, Gulshan", contact: "0333-5551234", status: "Active", emptyBottles: 10 },
  Hassan: { name: "Hassan Ali", address: "Block 7, Johar", contact: "0300-1122334", status: "Active", emptyBottles: 7 },
  Bilal: { name: "Bilal Ahmed", address: "Phase 5, DHA", contact: "0345-6677889", status: "Inactive", emptyBottles: 5 },
};

    const pendingData = {
      Imran: [
        { month: "Sep 2025", balance: 1200, status: "Pending" },
        { month: "Oct 2025", balance: 1300, status: "Pending" },
      ],
      Hassan: [
        { month: "Oct 2025", balance: 900, status: "Pending" },
      ],
      Bilal: [
        { month: "Sep 2025", balance: 1000, status: "Pending" },
        { month: "Oct 2025", balance: 1000, status: "Pending" },
      ],
    };

    const collectedData = [];

    let selectedClient = "";
    let selectedRow = null;

    function loadClientInfo() {
      const clientKey = document.getElementById("clientSelect").value;
      const infoDiv = document.getElementById("clientInfo");
      const tbody = document.querySelector("#pendingTable tbody");
      tbody.innerHTML = "";

      if (!clientKey) {
        infoDiv.innerHTML = `<h6 class="fw-semibold text-primary">Client Information</h6><p>No client selected.</p>`;
        return;
      }

      selectedClient = clientKey;
      const client = clients[clientKey];
     infoDiv.innerHTML = `
  <h6 class="fw-semibold text-primary">Client Information</h6>
  <p><strong>Name:</strong> ${client.name}</p>
  <p><strong>Address:</strong> ${client.address}</p>
  <p><strong>Contact:</strong> ${client.contact}</p>
 
  <p><strong>Status:</strong> ${client.status}</p>
<p><strong>Empty Bottles Remaining:</strong> <span id="bottleCount_${clientKey}" class="text-primary fw-semibold">${client.emptyBottles}</span></p>

  <button class="btn btn-outline-success btn-sm mt-2" onclick="openBottleModal('${clientKey}')">Manage Bottles</button>
`;

      const data = pendingData[clientKey] || [];
      data.forEach((item, i) => {
        tbody.innerHTML += `
          <tr>
            <td>${client.name}</td>
            <td>${client.address}</td>
            <td>${item.month}</td>
            <td>${item.balance}</td>
            <td><span class="badge bg-warning">${item.status}</span></td>
          <td>
  <button class="btn btn-sm btn-primary me-1" onclick="openCollectModal('${clientKey}', ${i})">Collect</button>
  
</td>
            </tr>`;
      });
    }

   function openCollectModal(clientKey, index) {
  selectedClient = clientKey;
  selectedRow = index;
  const client = clients[clientKey];
  const entry = pendingData[clientKey][index];

  document.getElementById("modalClientName").innerText = client.name;
  document.getElementById("modalAmount").innerText = entry.balance;

  // Pre-fill editable amount
  const receivedInput = document.getElementById("receivedAmount");
  receivedInput.value = entry.balance;

  const modal = new bootstrap.Modal(document.getElementById("collectModal"));
  modal.show();
}
   function confirmCollection() {
  const client = clients[selectedClient];
  const entry = pendingData[selectedClient][selectedRow];

  const enteredAmount = parseFloat(document.getElementById("receivedAmount").value) || 0;
  const bottlesReceived = parseInt(document.getElementById("bottlesReceived").value) || 0;

  if (enteredAmount <= 0) {
    alert("âš ï¸ Please enter a valid amount.");
    return;
  }

  // âœ… Update empty bottle count
  if (bottlesReceived > 0) {
    client.emptyBottles = Math.max(0, client.emptyBottles - bottlesReceived);
    document.getElementById(`bottleCount_${selectedClient}`).innerText = client.emptyBottles;
  }

  // âœ… Remove from pending and add to collected
  pendingData[selectedClient].splice(selectedRow, 1);
  collectedData.push({
    name: client.name,
    address: client.address,
    month: entry.month,
    amount: enteredAmount,
    date: new Date().toLocaleDateString(),
    bottlesReceived: bottlesReceived
  });

  // Refresh UI
  loadClientInfo();
  updateCollectedTable();

  const modal = bootstrap.Modal.getInstance(document.getElementById("collectModal"));
  modal.hide();

  alert(`âœ… PKR ${enteredAmount} collected from ${client.name}.
${bottlesReceived > 0 ? `ðŸ§´ ${bottlesReceived} empty bottles received.` : ""}`);
}

function updateCollectedTable() {
  const tbody = document.querySelector("#collectedTable tbody");
  tbody.innerHTML = "";
  collectedData.forEach((c) => {
    tbody.innerHTML += `
      <tr>
        <td>${c.name}</td>
        <td>${c.address}</td>
        <td>${c.month}</td>
        <td>${c.amount}</td>
        <td>${c.bottlesReceived || 0}</td>
        <td>${c.date}</td>
      </tr>`;
  });
}


let bottleClient = null;
let bottleRow = null;

function openBottleModal(clientKey) {
  bottleClient = clientKey;
  const client = clients[clientKey];
  document.getElementById("bottleClientName").innerText = client.name;
  document.getElementById("bottleScenario").value = "";
  document.getElementById("bottleFields").innerHTML = "";
  const modal = new bootstrap.Modal(document.getElementById("bottleModal"));
  modal.show();
}

function updateScenarioFields() {
  const type = document.getElementById("bottleScenario").value;
  const container = document.getElementById("bottleFields");

  if (type === "permanent") {
    container.innerHTML = `
      <label class="form-label fw-semibold">Add Bottles</label>
      <input type="number" id="bottleCount" class="form-control mb-3" placeholder="Enter bottles to add" />
      <p class="small text-muted">ðŸ’° System will auto-create new amount entries (PKR 1000 per bottle).</p>
    `;
  } else if (type === "temporary") {
  container.innerHTML = `
    <label class="form-label fw-semibold">Add Temporary Bottles</label>
    <input type="number" id="bottleCount" class="form-control mb-2" placeholder="Enter bottles to add" />
    <label class="form-label fw-semibold">Validity Period</label>
    <input type="date" id="validity" class="form-control mb-3" />
    <p class="small text-muted">ðŸ•“ Temporary bottles will be auto-removed after the validity date.</p>
  `;
} else if (type === "replacement") {
    container.innerHTML = `
      <label class="form-label fw-semibold">Replaced Bottles</label>
      <input type="number" id="bottleCount" class="form-control mb-3" placeholder="Enter bottles replaced" />
      <p class="small text-muted">ðŸ”„ Replacement is free of cost. No amount entry will be created.</p>
    `;
  } else {
    container.innerHTML = "";
  }
}

function saveBottleChanges() {
  const scenario = document.getElementById("bottleScenario").value;
  const count = parseInt(document.getElementById("bottleCount")?.value || 0);
  const validity = document.getElementById("validity")?.value || "";

  if (!scenario || count <= 0) {
    alert("âš ï¸ Please complete all fields before saving.");
    return;
  }

  const client = clients[bottleClient];
  const today = new Date();
  const monthYear = today.toLocaleString("default", { month: "short", year: "numeric" });

  // âœ… Permanent Bottle Increase â†’ Add to pending
  if (scenario === "permanent") {
    const amountPerBottle = 1000;
    const newAmount = count * amountPerBottle;

    // Add new record into pendingData
    if (!pendingData[bottleClient]) pendingData[bottleClient] = [];
    pendingData[bottleClient].push({
      month: monthYear,
      balance: newAmount,
      status: "Pending",
    });

    alert(`âœ… ${count} permanent bottles added for ${client.name}. PKR ${newAmount} added to pending.`);
    updatePendingTable(bottleClient); // refresh table
  }

  // ðŸ•“ Temporary Increase - Just informational
  else if (scenario === "temporary") {
    alert(`ðŸ•“ ${count} temporary bottles added for ${client.name}. Valid until ${validity}.`);
  }

  // â™»ï¸ Free Replacement - No billing entry
  else if (scenario === "replacement") {
    alert(`â™»ï¸ ${count} bottles replaced free of cost for ${client.name}.`);
  }

  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById("bottleModal"));
  modal.hide();
}


function updatePendingTable(clientKey) {
  const tbody = document.querySelector("#pendingTable tbody");
  tbody.innerHTML = "";

  const client = clients[clientKey];
  const data = pendingData[clientKey] || [];

  data.forEach((item, i) => {
    tbody.innerHTML += `
      <tr>
        <td>${client.name}</td>
        <td>${client.address}</td>
        <td>${item.month}</td>
        <td>${item.balance}</td>
        <td><span class="badge bg-warning">${item.status}</span></td>
        <td>
          <button class="btn btn-sm btn-primary me-1" onclick="openCollectModal('${clientKey}', ${i})">Collect</button>
        </td>
      </tr>`;
  });
}






  </script>

<script src="sidebar.js"></script>
</body>
</html>

